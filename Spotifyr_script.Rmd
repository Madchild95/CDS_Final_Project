---
title: "Practice for Final Project"
author: "Matilde Jacobsen"
date: "10/4/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Install packages

```{r setup, include=FALSE}
#Clean environment
rm(list = ls())

pacman::p_load(dplyr,
               tidyverse,
               devtools,
               glue,
               fansi,
               plotly,
               knitr, #package from Spotifyr tutorial
               lubridate, #package from Spotifyr tutorial
               googledrive, #from Jacob's script
               tibble, #from Jacob's script
               wordcloud,
               highcharter
               )

install_github('charlie86/spotifyr', force = T)
library(spotifyr)

```

## Authentication

First, set up a Developer account with Spotify to access their Web API here and CREATE AN APP from the Dashboard site. This will give you your Client ID and Client Secret. Once you have those, you can pull your access token into R with get_spotify_access_token().
```{r cars, include=FALSE}
id <- '135dfc17ee1c4faea6c0f8ccda27734f'
secret <- '596b88ec42444418a592fc3fcb539e89'
Sys.setenv(SPOTIFY_CLIENT_ID = id)
Sys.setenv(SPOTIFY_CLIENT_SECRET = secret)

access_token <- spotifyr::get_spotify_access_token()
#authorization_code <- get_spotify_authorization_code((scope = "user-top-read"))
```

## Spotifyr pratice

I will try to make my first usage of Spotifyr as described by https://github.com/charlie86/spotifyr 


```{r }
#What was The Beatlesâ€™ favorite key?
beatles <- get_artist_audio_features('the beatles')
radiohead <- get_artist_audio_features('radiohead')

beatles %>% 
    count(key_mode, sort = TRUE) %>% 
    head(5) %>% 
    kable()
#Get your most recently played tracks
get_my_recently_played(limit = 5) %>% 
    mutate(artist.name = map_chr(track.artists, function(x) x$name[1]),
           played_at = as_datetime(played_at)) %>% 
    select(track.name, artist.name, track.album.name, played_at) %>% 
    kable()

#Find your all time favorite artists
get_my_top_artists_or_tracks(type = 'artists', time_range = 'long_term', limit = 5) %>% 
    select(name, genres) %>% 
    rowwise %>% 
    mutate(genres = paste(genres, collapse = ', ')) %>% 
    ungroup %>% 
    kable()


#Find your favorite tracks at the moment
get_my_top_artists_or_tracks(type = 'tracks', time_range = 'short_term', limit = 5) %>% 
    mutate(artist.name = map_chr(artists, function(x) x$name[1])) %>% 
    select(name, artist.name, album.name) %>% 
    kable()

#Find your all time favorite tracks
my_fav_tracks_20 <- tibble(get_my_top_artists_or_tracks(type = 'tracks', time_range = 'long_term', limit = 20) %>% 
    mutate(artist.name = map_chr(artists, function(x) x$name[1]))) 
    #select(name, artist.name, album.name))

#Get new album releases
new_releases <- tibble(get_new_releases(include_meta_info = T))
new_releases_br <- tibble(get_new_releases(include_meta_info = T) %>% 
    mutate(artist.name = map_chr(artists, function(x) x$name[1])) %>% 
    select(name, artist.name, release_date, total_tracks, type, country, offset, limit))

#Country specific
new_releases_br <- tibble(get_new_releases(country = 'BR') %>% 
    mutate(artist.name = map_chr(artists, function(x) x$name[1])) %>% 
    select(name, artist.name, release_date, total_tracks, type))

```


## Exploring the Spotify API with R tutorial

I followed this beginners guide to make some initial plots https://msmith7161.github.io/what-is-speechiness/

```{r}
#Type in the ID that you want to explore
my_id <- 'charlotte.jacobsen'
e_id <- '1111913951'
#Get playlists from the account charotte.jacobsen
my_plists <- get_user_playlists(my_id)
my_plists <- get_user_playlists(e_id)
#Filter playlists where owner is charlotte.jacobsen
my_plists2 <- my_plists %>%
  subset(owner.display_name == 'charlotte.jacobsen')


#Get most 
sahara <- my_plists %>% filter(name %in% c('Sahara',"Sahara music"))
tracks <- get_playlist_tracks(sahara$id[1])
tracks <- tracks %>% rename(uri = track.uri)
features <- get_track_audio_features(tracks$track.id)

sahara_merged <- merge(tracks, features, by = "uri")
sahara_merged <- sahara_merged %>% select(c("track.name", "track.popularity", "track.album.artists", "track.album.name", "danceability", "energy", "key", "loudness", "mode", "speechiness","acousticness", "instrumentalness", "liveness", "valence", "tempo", "type"))
cols <- colnames(sahara_merged)
allData <- data.frame(matrix(ncol = length(cols), nrow = 0))
colnames(allData) <- cols

for (i in 1:length(sahara$id)){
  tracks <- get_playlist_tracks(sahara$id[i])
  tracks <- tracks %>% rename(uri = track.uri)
  features <- get_track_audio_features(tracks$track.id)
  merged <- merge(tracks, features, by = 'uri')
  merged <- merged %>% select(c("track.name", "track.popularity", "track.album.artists", "track.album.name", "danceability", "energy", "key", "loudness", "mode", "speechiness","acousticness", "instrumentalness", "liveness", "valence", "tempo", "type"))
  if (nrow(allData) == 0){
    allData <- merged
  } else{
    allData <- rbind(allData, merged)
  }
}



```


##Sentify

I will try to create a plot of the sentiment based on the Sentify plotmaker: http://www.rcharlie.net/sentify/
```{r}
#I found this function to get the sentiment score of a song
classify_track_sentiment <- function(valence, energy) {
    if (is.na(valence) | is.na(energy)) {
        return(NA)
    }
    else if (valence >= .5) {
        if (energy >= .5) {
            return('Happy/Joyful')
        } else {
            return('Chill/Peaceful')
        }
    } else {
        if (energy >= .5) {
            return('Turbulent/Angry')
        } else {
            return('Sad/Depressing')
        }
    }
}

#apply function
allData <- allData %>% 
        rowwise() %>% 
        mutate(sentiment = classify_track_sentiment(valence, energy)) %>% 
        ungroup

#make plot 
df2 <- data.frame(x = c(0, .9, 0, .9),
                      y = c(1, 1, 0, 0),
                      text = c('Turbulent/Angry',
                               'Happy/Joyful',
                               'Sad/Depressing',
                               'Chill/Peaceful'))
sentiment_profiles %>% ggplot(aes(x = 'valence', y = 'energy', group = 'track.name'), type = 'scatter') %>% 
  #hc_tooltip(formatter = JS(paste0("function() {return this.point.tooltip;}")), useHTML = T) %>%
  yAxis(max = 1, min = 0, title = list(text = 'Energy')) %>%
  xAxis(max = 1, min = 0, title = list(text = 'Valence')) %>%
  theme_set(theme_dark) %>% 
  colors(neon_colors) %>% 
  yAxis(plotLines = list(list(
      value = .5,
      color = 'black',
      width = 2,
      zIndex = 2))) %>% 
  xAxis(plotLines = list(list(
      value = .5,
      color = 'black',
      width = 2,
      zIndex = 2))) %>% 
  add_series(data = ds2,
                name = 'annotations',
                type = 'scatter',
                color = 'transparent',
                showInLegend = FALSE,
                enableMouseTracking = FALSE,
                zIndex = 0,
                dataLabels = list(enabled = TRUE, y = 10, format = "{point.text}",
                                        style = list(fontSize = "18px",
                                                     color =  '#fff',
                                                     textOutline = '0px')))


```


## Following Jacob's scrips

I adopted the scripts from Jacob Dalsgaard https://github.com/jacdals97/spotifyr_scripts/blob/main/my_favourites.R to get a csv file of favorite tracks
```{r}
name <- "Matilde"
#Placeholder for the file to be written
file_name <- paste0("mft_", name, ".csv")

#Getting the top played tracks for three time periods
#long term
my_favorite_tracks <- tibble(get_my_top_artists_or_tracks(type = "tracks", limit = 50, time_range = "long_term",
                                                   authorization = get_spotify_authorization_code(scope = "user-top-read"))[,7:10],
                             #%>% mutate(artist.name = map_chr(artists, function(x) x$name[1])),
                             period = "all_time") %>% 
  bind_cols(get_track_audio_features(.$id)) 
#middle term
my_favorite_tracks <- bind_rows(my_favorite_tracks,
                                tibble(get_my_top_artists_or_tracks(type = "tracks", limit = 50, time_range = "medium_term",
                                                authorization = get_spotify_authorization_code(scope = "user-top-read"))[,7:10],
                   period = "medium_term") %>% 
  bind_cols(get_track_audio_features(.$id)))
#short term
my_favorite_tracks <- bind_rows(my_favorite_tracks,
  tibble(get_my_top_artists_or_tracks(type = "tracks", limit = 50,  time_range = "short_term",
                                                authorization = get_spotify_authorization_code(scope = "user-top-read"))[,7:10],
                   period = "short_term") %>%
    bind_cols(get_track_audio_features(.$id)))
  
#Creating a .csv file of favorite tracks
write.csv(my_favorite_tracks, file_name)

#Reading the same file
my_favorite_tracks <- read.csv("mft_Matilde.csv")

#Creating a normalize function
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}

#Normalizing loudness and tempo
my_favorite_tracks$loudness_norm <- normalize(my_favorite_tracks$loudness)
my_favorite_tracks$tempo_norm <- normalize(my_favorite_tracks$tempo)

#Renaming certain columns
my_favorite_tracks <- tibble(get_my_top_artists_or_tracks(type = 'tracks', time_range = 'long_term') %>% 
    mutate(artist.name = map_chr(artists, function(x) x$name[1]))) %>% 
    select(name, artist.name, album.name)

#Creating an object of top songs
top_songs <- my_favorite_tracks %>% group_by(name) %>% summarise(freq = n())
topsongs_all <- my_favorite_tracks %>% group_by(name) %>% summarise(freq = n())

wordcloud::wordcloud(top_songs$name, top_songs$freq, scale=c(1.5,0.2), min.freq = 2, max.words = 50, 
                     random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

top_artists <- my_favorite_tracks %>% group_by(artist.name) %>% summarise(freq = n())
topartists_all <- my_favorite_tracks %>% group_by(artist.name) %>% summarise(freq = n())

wordcloud::wordcloud(top_artists$artist.name, top_artists$freq, scale=c(1.5,0.2), min.freq = 0, max.words = 50, 
                     random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

```

##Practicing High Charter package

```{r}
remotes::install_github("allisonhorst/palmerpenguins")
library(highcharter)
data(penguins, package = "palmerpenguins")
hchart(penguins, "scatter", hcaes(x = flipper_length_mm, y = bill_length_mm, group = species))

```

